#include <Arduino.h>
#include <Adafruit_TinyUSB.h>
#include "display_sharp.h"

SharpDisplay display;
unsigned long lastToggle = 0;
unsigned long testPhase = 0;

void setup() {
    Serial.begin(115200);
    delay(3000);
    
    Serial.println("\n========================================");
    Serial.println("GeekWatch - Display Test");
    Serial.println("========================================");
    
    Serial.print("Initializing display... ");
    if (display.begin()) {
        Serial.println("SUCCESS");
    } else {
        Serial.println("FAILED");
        while(1) delay(100);
    }
    
    Serial.println("\nTest sequence:");
    Serial.println("1. Clear screen (black)");
    Serial.println("2. Fill screen (white)");
    Serial.println("3. Draw test pattern");
    Serial.println("========================================\n");
    
    delay(1000);
}

void loop() {
    unsigned long now = millis();
    
    // Simple test - just alternate between all white and all black every 3 seconds
    unsigned long phase = (now / 3000) % 2;
    
    if (phase != testPhase) {
        testPhase = phase;
        
        if (testPhase == 0) {
            Serial.println("\n========================================");
            Serial.println("[TEST] Filling ALL pixels WHITE");
            Serial.println("========================================");
            display.fillScreen(true);
        } else {
            Serial.println("\n========================================");
            Serial.println("[TEST] Clearing ALL pixels (BLACK)");
            Serial.println("========================================");
            display.clearDisplay();
        }
        
        Serial.println("If you see NO change on display:");
        Serial.println("  - SPI data might not be reaching display");
        Serial.println("  - Try different SPI mode or bit order");
        Serial.println("");
    }
    
    // Toggle VCOM every second (required for Sharp displays)
    if (now - lastToggle >= 1000) {
        display.toggleVCOM();
        lastToggle = now;
    }
    
    delay(100);
}
